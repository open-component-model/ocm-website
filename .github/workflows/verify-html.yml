name: Verify HTML Links on rendered website

on:
  pull_request:
    branches:
      - main
      - website/**

permissions:
  contents: read
  checks: read

jobs:
  check-links:
    name: Check external links (Netlify Deploy Preview)
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v4
        with:
          fetch-depth: 0 # fetch all history for the PR

      - name: Wait for Netlify Deploy Preview
        id: wait_for_preview
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting up to 10 minutes for Netlify deploy preview..."
          export REPO="${{ github.repository }}"
          export SHA="${{ github.event.pull_request.head.sha }}"

          timeout 600 bash -c '
            while true; do
              # Get check suite for Netlify app
              SUITE_JSON=$(
                gh api repos/"$REPO"/commits/"$SHA"/check-suites \
                  --jq "[ .check_suites[] | select(.app.slug == \"netlify\") ]" 2>/dev/null
              )

              # no suite available? sleep and retry
              if [ "$(echo "$SUITE_JSON" | jq length)" -eq 0 ]; then
                sleep 5
                continue
              fi

              # Read suite ID, status and conclusion
              SUITE_ID=$(echo "$SUITE_JSON" | jq -r ".[0].id")
              STATUS=$(echo    "$SUITE_JSON" | jq -r ".[0].status")
              CONCLUSION=$(echo "$SUITE_JSON" | jq -r ".[0].conclusion")

              echo "Netlify suite status: $STATUS, conclusion: $CONCLUSION"

              if [ "$STATUS" = "completed" ]; then
                if [[ "$CONCLUSION" = "success" || "$CONCLUSION" = "neutral" ]]; then
                  # Get deploy preview URL from status
                  STATUS_JSON=$(gh api repos/"$REPO"/commits/"$SHA"/status \
                    --jq ".statuses[] | select(.context==\"netlify/open-component-model/deploy-preview\")" 2>/dev/null
                  )

                  PREVIEW_URL=$(echo "$STATUS_JSON" | jq -r '.target_url')

                  echo "✅ Deploy Preview ready: $PREVIEW_URL"
                  echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "❌ Deploy failed: $CONCLUSION"
                  exit 1
                fi
              fi

              # still pending? 
              sleep 15
            done
          '

          #  timeout returns 124 if command times out
          if [ $? -eq 124 ]; then
            echo "❌ Timeout after 10 minutes"
            exit 1
          fi
      - name: Give Netlify time to stabilize
        run: |
          echo "Waiting 30 seconds for Netlify to fully stabilize..."
          sleep 30

      - name: Fetch versions list from main
        run: |
          curl -fsSL \
            "https://raw.githubusercontent.com/open-component-model/ocm-website/refs/heads/main/data/versions.json" \
            -o versions-main.json
          
          echo "versions-main.json:"
          cat versions-main.json

      - name: Build URL list from all index.json files
        run: |
          set -euo pipefail

          PREVIEW_URL="${{ steps.wait_for_preview.outputs.preview_url }}"
          echo "Preview URL: $PREVIEW_URL"

          # Get versions from main branch /data/versions.json
          DEFAULT_VERSION=$(jq -r '.defaultVersion' versions-main.json)
          VERSIONS=$(jq -r '.versions[]' versions-main.json)

          echo "Default version: $DEFAULT_VERSION"
          echo "Versions: $VERSIONS"
          # Prepare URLs file
          URLS_FILE="urls.txt"
          # ':' built-in "no-op", redirected to a file, empties it or creates a new file, if it doesn't exist
          : > "$URLS_FILE"

          for v in $VERSIONS; do
            if [ "$v" = "$DEFAULT_VERSION" ]; then
              INDEX_URL="${PREVIEW_URL%/}/index.json"
              LABEL="root"
            else
              INDEX_URL="${PREVIEW_URL%/}/$v/index.json"
              LABEL="$v"
            fi

            echo "Fetching index for version '$v' from: $INDEX_URL"

            FOUND=0

            if curl -fsS "$INDEX_URL" -o "index-${LABEL}.json"; then
              FOUND=1
              echo "  -> OK, parsing URLs from index-${LABEL}.json"
              jq -r '.[]' "index-${LABEL}.json" >> "$URLS_FILE"
            fi

            if [ "$FOUND" -eq 0 ]; then
              echo "::warning::index.json for version '$v' not found at $INDEX_URL"
            fi
          done

          # Remove duplicate URLs
          sort -u "$URLS_FILE" -o "$URLS_FILE"

          echo "Final URLs to check:"
          cat "$URLS_FILE"
      

      # Run lychee on all URLs
      - name: Run lychee
        uses: lycheeverse/lychee-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >-
            --no-progress
            --include-fragments
            --max-concurrency 2
            --max-retries 10
            --retry-wait-time 8
            --timeout 45
            --accept 200,201,204,301,302,307,308,429,503
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            --files-from urls.txt
          fail: true
          output: lychee/out.md
          format: markdown

      - name: Show detailed results
        if: always()
        run: |
          if [ -f lychee/out.md ]; then
            echo "=== Detailed Lychee Report ==="
            cat lychee/out.md
          fi

      - name: Upload lychee report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lychee-report
          path: lychee/out.md
