name: Markdown

on:
  push:
    branches:
      - main
    paths:
      - '**/*.md'
  pull_request:
    branches:
      - main
    paths:
      - '**/*.md'

jobs:
  markdown-lint:
    runs-on: ubuntu-latest
    name: Lint Markdown
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - uses: DavidAnson/markdownlint-cli2-action@992badcdf24e3b8eb7e87ff9287fe931bcb00c6e # v20
        with:
          globs: '**/*.md'
          separator: ","
          config: .github/config/.markdownlint-cli2.yaml

  spellcheck:
    name: Spellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Spellcheck
        uses: rojopolis/spellcheck-github-actions@35a02bae020e6999c5c37fabaf447f2eb8822ca7 # v0
        with:
          config_path: .github/config/spellcheck.yml
          task_name: Markdown
  verify-links:
    name: Verify links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
      - name: Wait for Netlify Deploy Preview
        id: wait_for_preview
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Waiting up to 10 minutes for Netlify deploy preview..."
          export REPO="${{ github.repository }}"
          export SHA="${{ github.event.pull_request.head.sha }}"

          timeout 600 bash -c '
            while true; do
              # Get check suite for Netlify app
              SUITE_JSON=$(
                gh api repos/"$REPO"/commits/"$SHA"/check-suites \
                  --jq "[ .check_suites[] | select(.app.slug == \"netlify\") ]" 2>/dev/null
              )

              # no suite available? sleep and retry
              if [ "$(echo "$SUITE_JSON" | jq length)" -eq 0 ]; then
                sleep 5
                continue
              fi

              # Read suite ID, status and conclusion
              SUITE_ID=$(echo "$SUITE_JSON" | jq -r ".[0].id")
              STATUS=$(echo    "$SUITE_JSON" | jq -r ".[0].status")
              CONCLUSION=$(echo "$SUITE_JSON" | jq -r ".[0].conclusion")

              echo "Netlify suite status: $STATUS, conclusion: $CONCLUSION"

              if [ "$STATUS" = "completed" ]; then
                if [[ "$CONCLUSION" = "success" || "$CONCLUSION" = "neutral" ]]; then
                  # Get deploy preview URL from status
                  STATUS_JSON=$(gh api repos/"$REPO"/commits/"$SHA"/status \
                    --jq ".statuses[] | select(.context==\"netlify/open-component-model/deploy-preview\")" 2>/dev/null
                  )

                  PREVIEW_URL=$(echo "$STATUS_JSON" | jq -r '.target_url')

                  echo "✅ Deploy Preview ready: $PREVIEW_URL"
                  echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
                  exit 0
                else
                  echo "❌ Deploy failed: $CONCLUSION"
                  exit 1
                fi
              fi

              # still pending? 
              sleep 15
            done
          '

          #  timeout returns 124 if command times out
          if [ $? -eq 124 ]; then
            echo "❌ Timeout after 10 minutes"
            exit 1
          fi

      - name: Generate linkspector config
        # The linkspector config needs to be generated dynamically as
        # the action does not support passing the base URL as an environment variable.
        run: |
          cat > .github/config/linkspector.yaml << EOF
          dirs:
            - ./content
          baseUrl: "$BASEURL"
          ignorePatterns:
            - pattern: '/images/.*'
          EOF
          
          echo "Generated config:"
          cat .github/config/linkspector.yaml
        env:
          BASEURL: ${{ steps.wait_for_preview.outputs.preview_url }}
      - name: Run linkspector
        uses: umbrelladocs/action-linkspector@874d01cae9fd488e3077b08952093235bd626977 # v1
        with:
          github_token: ${{ secrets.github_token }}
          reporter: github-pr-check
          fail_level: any
          config_file: .github/config/linkspector.yaml
          show_stats: true
        env:
          BASEURL: ${{ steps.wait_for_preview.outputs.preview_url }}
